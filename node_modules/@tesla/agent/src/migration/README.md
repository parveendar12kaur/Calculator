## Migration Case Studies

#### Migration Rules Lexicon

**Note**:

* `migrations` is an array, it contains all lexicon changes (`migration items`) between source lexicon and target lexicon
*  We can use this migration lexicon to upgrade/downgrade configuration from current lexicon to the specific lexicon
*  The migration can happen either from Marketing configuration end or Manufacturing configuration end. If it happens in one end, we just need to make sure we re-generate the other one with `transformation` lexicon
*  For each migration rule, if the option key doesn't exist in the target lexicon, we will trigger `unset_rules`, otherwise `set_rules` will be processed.
*  For lexicon upgrade (target lexicon is released after source lexicon), we will get the migration different between target lexicon and source lexicon, then sort the diff migration items by ASC (default sorting)
*  For lexicon downgrade (target lexicon is released before source lexicon), we will get the migration different between source lexicon and target lexiconsort migration items by timestamp DESC

##### Migration Lexicon Object (Injected to current lexicons)
```
"migrations": [
    {
        "comments": "New Lexicon Release at timestamp 1502226573007, this migrations array should sorted by created timestamp ASC",
        "options": {
            "$AAAA": {
                "set_rules": [
                    {
                        "action": "set",
                        "target": "$AAAA"
                    },
                    {
                        "action": "unset",
                        "target": "$AAA1"
                    }
                ],
                "unset_rules": [
                    {
                        "action": "unset",
                        "target": "$AAAA"
                    },
                    {
                        "action": "set",
                        "target": "$AAA1"
                    }
                ],
                "comments": "swap $AAAA to $AAA1 in new lexicon"
            }
        }
    },
    {
        "comments": "New Lexicon Release at timestamp 1502236573007, this migrations array should sorted by created timestamp ASC",
        "options": {
            "$BBBB": {
                "set_rules": [
                    {
                        "action": "set",
                        "target": "$BBBB"
                    },
                    {
                        "action": "unset",
                        "target": "$AAA0"
                    },
                    {
                        "action": "set",
                        "target": "$AAA1"
                    }
                ],
                "unset_rules": [
                ],
                "comments": "Update $BBBB's require/exclude rules in new lexicon"
            }
        }
    }
]
```

### Migration Cases:

#### 1. Replace an option code with a new one

* Current lexicon: `Lexicon1`
* New lexicon: `Lexicon2`
* Option to be replaced: `$AAA0`
* New option candidate: `$AAA1`
* Source option list `["$AAA0", "$MDL3"]`
* Migration rules between `Lexicon1` and `Lexicon2`

```
"$AAA0": {
    "set_rules": [
        {
            "action": "set",
            "target": "$AAA0"
        },
        {
            "action": "unset",
            "target": "$AAA1"
        }
    ],
    "unset_rules": [
        {
            "action": "unset",
            "target": "$AAA0"
        },
        {
            "action": "set",
            "target": "$AAA1"
        }
    ],
    "comments": "swap $AAA0 to $AAA1"
}
```
	
	
##### Upgrade Steps:

a. Get option list from given configuration `["$AAA0", "$MDL3"]`
b. Get the source lexicon of given configuration `Lexicon1`
c. Use `Lexicon1` to validate the option list `["$AAA0", "$MDL3"]`, if it is valid, go to step `c`, otherwise return exceptions
d. Get target lexicon and migration lexicon rules from target lexicon. We can update option list from `["$AAA0", "$MDL3"]` to  `["$AAA1", "$MDL3"]`
e. Use `setOptions` to set options from step `d` based on the default configurations by following the rules we defined in marketing/manufacturing lexicon (`Lexicon2`)
f. Use `transformation` API to get the new manufacturing/marketing option list

##### Downgrade steps:

a. Get option list from given configuration `["$AAA1", "$MDL3"]`
b. Get the source lexicon of given configuration `Lexicon2`
c. Use `Lexicon2` to validate the option list `["$AAA1", "$MDL3"]`, if it is valid, go to step `c`, otherwise return exceptions
d. Get target lexicon and migration lexicon rules from source lexicon. We can update option list from `["$AAA1", "$MDL3"]` to  `["$AAA0", "$MDL3"]`
e. Use `setOptions` to set options from step `d` based on the default configurations by following the rules we defined in marketing/manufacturing lexicon (`Lexicon1`)
f. Use `transformation` API to get the new manufacturing/marketing option list

#### 2. Update option code require/exclude rules

* Current lexicon: `Lexicon1`
* New lexicon: `Lexicon2`
* Option rules to be replaced: `$AAA0` requires `$BBB0` and excludes `$BBB1`
* New option rules: `$AAA0` requires `$BBB1` and excludes `$BBB0`
* Source option list `["$AAA0", "$BBB0", "$MDL3"]`
* Migration rules between `Lexicon1` and `Lexicon2`
* Upgrade Expected result ["$AAA0", "$BBB1", "$MDL3"]

```
"$AAA0": {
    "set_rules": [
        {
            "action": "set",
            "target": "$AAAA"
        },
        {
            "action": "set",
            "target": "$BBB1"
        },
        {
            "action": "unset",
            "target": "$BBB0"
        }
    ],
    "unset_rules": [
    ],
    "comments": "Make sure $AAA0 requires $BBB1"
}
```

##### Upgrade Steps:

a. Get option list from given configuration `["$AAA0", "$BBB0", "$MDL3"]`
b. Get the source lexicon of given configuration `Lexicon1`
c. Use `Lexicon1` to validate the option list `["$AAA0", "$BBB0", "$MDL3"]`, if it is valid, go to step `d`, otherwise return exceptions
d. Get target lexicon and migration lexicon rules. Since `$AAA0` exist in both lexicon. We need to determine the upgrade/downgrade direction by comparing the `effective_date` of source lexicon and target lexicon. Here we will get `upgrade` direction. 
e. We can update option list from `["$AAA0", "$BBB0", "$MDL3"]` to  `["$AAA0", "$BBB1", "$MDL3"]`
f. Use `setOptions` to set options from step `e` based on the default configurations by following the rules we defined in marketing/manufacturing lexicon (`Lexicon2`)
g. Use `transformation` API to get the new manufacturing/marketing option list

##### Downgrade steps:

a. Get option list from given configuration `["$AAA1", "$BBB1", "$MDL3"]`
b. Get the source lexicon of given configuration `Lexicon2`
c. Use `Lexicon2` to validate the option list `["$AAA0", "$BBB1", "$MDL3"]`, if it is valid, go to step `d`, otherwise return exceptions
d. Get target lexicon and migration lexicon rules. Since `$AAA0` exist in both lexicon. We need to determine the upgrade/downgrade direction by comparing the `effective_date` of source lexicon and target lexicon. Here we will get `downgrade` direction. 
e. We need to reverse the `migrations` array. And dynamically toggle the `action` from `set` to `unset` (vice versa). So we will get the new `migrations`:
```
"$AAA0": {
    "set_rules": [
        {
            "action": "set",
            "target": "$AAAA"
        },
        {
            "action": "unset",
            "target": "$BBB1"
        },
        {
            "action": "set",
            "target": "$BBB0"
        }
    ],
    "unset_rules": [
    ],
    "comments": "Make sure $AAA0 requires $BBB1"
}
```
f. Then we can update option list from `["$AAA0", "$BBB1", "$MDL3"]` to  `["$AAA0", "$BBB0", "$MDL3"]`
g. Use `setOptions` to set options from step `e` based on the default configurations by following the rules we defined in marketing/manufacturing lexicon (`Lexicon1`)
h. Use `transformation` API to get the new manufacturing/marketing option list

#### 3. Discontinue an option code

* Current lexicon: `Lexicon1`
* New lexicon: `Lexicon2`
* Option to be deleted: `$AAA0`
* Source option list `["$AAA0", "$MDL3"]`
* We don't need to set migration rules between `Lexicon1` and `Lexicon2`, what we need is to make sure we don't have `$AAA0` in the `transformation lexicon` after we release `Lexicon2`

##### Upgrade Steps:

a. Use `Lexicon1` to validate the option list `["$AAA0", "$MDL3"]`, if it is valid, go to step `b`, otherwise return exceptions
b. Use `setOptions` to set options from step `a` based on the default configurations by following the rules we defined in marketing/manufacturing lexicon (`Lexicon2`)
d. Use `transformation` API to get the new manufacturing/marketing option list

##### Downgrade steps:

a. Use `Lexicon2` to validate the option list `["$MDL3"]`, if it is valid, go to step `b`, otherwise return exceptions
b. Use `setOptions` to set options from step `a` based on the default configurations by following the rules we defined in marketing/manufacturing lexicon (`Lexicon1`)
c. Use `transformation` API to get the new manufacturing/marketing option list


#### 4. Add a new option code

* Current lexicon: `Lexicon1`
* New lexicon: `Lexicon2`
* Option to be added: `$AAA0`
* Source option list `["$MDL3"]`
* We don't need to set migration rules between `Lexicon1` and `Lexicon2`, what we need is to make sure we do have `$AAA0` in the `transformation lexicon` after we release `Lexicon2`

##### Upgrade Steps:

a. Use `Lexicon1` to validate the option list `["$MDL3"]`, if it is valid, go to step `b`, otherwise return exceptions
b. Use `setOptions` to set options from step `a` based on the default configurations by following the rules we defined in marketing/manufacturing lexicon (`Lexicon2`)
d. Use `transformation` API to get the new manufacturing/marketing option list

##### Downgrade steps:

a. Use `Lexicon2` to validate the option list `["$AAA0", "$MDL3"]`, if it is valid, go to step `b`, otherwise return exceptions
b. Use `setOptions` to set options from step `a` based on the default configurations by following the rules we defined in marketing/manufacturing lexicon (`Lexicon1`)
c. Use `transformation` API to get the new manufacturing/marketing option list


**Note:**
If you pass some arbitrary option code which doesn't exist in lexicon and try to use `Agent.toggleOption` method to toggle it, nothing will be happened. Since `Agent.toggleOption` will check if the existence of the option before the toggleOption action happens.


#### 5. Cross Country Migration (Not a case for now)

*  For cross country migration (assume we only handle this case from manufacturing end, we can re-generate the marketing option list with `transformation` api)
	* If source country lexicon has the same effective date as target country lexicon, we can validate the source option list, then use `setOption` to make it happen directly
	* If source country lexicon has the different effective date from target country lexicon, we need to validate the source option list, get the `migration lexicon`, apply it and then do the migration (regular migration workflow)

* For cross country migration, if we have some big different between source/target lexicon (for instance, we haven't released the battery code in target market), how to protect the configuration data?
* Is the case `Keep lexicon but inject/swap new option code to the configuration` still valid?