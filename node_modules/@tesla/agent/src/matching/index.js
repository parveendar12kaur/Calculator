const difference = require('lodash/difference');
const intersection = require('lodash/intersection');
const Lexicon = require('../utils/lexicon');
const TYPES = require('../utils/types');
const Validator = require('../validator');

module.exports = {
    matching,
    generateMatchingActions
};

function matching(customerOptions, inventoryOptions, lexicon) {
    let normalizedLexicon = Lexicon.normalizeLexicon(lexicon);
    let matchingActions = generateMatchingActions(customerOptions, inventoryOptions, normalizedLexicon.matching);
    let updatedInventoryOptions = Validator.toggleOptions({
        options: inventoryOptions,
        lexicon: normalizedLexicon,
        actions: matchingActions
    });
    return updatedInventoryOptions;
}

function generateMatchingActions(customerOptions, inventoryOptions, matchingGroups = []) {
    let customerOptionsDiff = difference(customerOptions, inventoryOptions);
    let inventoryOptionsDiff = difference(inventoryOptions, customerOptions);
    return matchingGroups.reduce((actions, {options}) => {
        let matchingOptionOfCustomerOptions = intersection(customerOptionsDiff, options);
        let matchingOptionOfInventoryOptions = intersection(inventoryOptionsDiff, options);
        if (matchingOptionOfCustomerOptions.length && matchingOptionOfInventoryOptions.length) {
            actions.push({
                action: TYPES.SET_RULE_ACTION,
                target: matchingOptionOfCustomerOptions[0]
            });
            actions.push({
                action: TYPES.UNSET_RULE_ACTION,
                target: matchingOptionOfInventoryOptions[0]
            });
        }
        return actions;
    }, []);
}
