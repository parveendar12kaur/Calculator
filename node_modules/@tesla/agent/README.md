# Options Agent

![Agent](./agent.jpg)

### Features

Please see [Agent](https://confluence.teslamotors.com/display/OC/Agent) documentation. If you want to test all of the methods `Agent` exposed quickly, you can visit [Agent Simulator](https://agent-simulator-tool-stage-global.dev.ow.tesla.services/), then open the browser developer tool, type `Agent` in the console. Have fun :)

### Updates

* 3.x.x version [Support migrations, upgrade, matching]
* 2.x.x version [Bug fixes, ES5 support]
* 1.x.x version [Full features, only target to ES6]

### How to use it

We provide a NPM module [`@tesla/agent`](https://npm.teslamotors.com/package/@tesla/agent), so you can use it isomorphically in both browser end or pure nodejs project. Just run 

```
    npm install @tesla/agent --save
```
Make sure you setup [NPM Tesla](https://npmregistry.teslamotors.com) as the private npm registry in the `.npmrc` file. Once you have the npm module set up in your project, you can follow the code snippets below.

**Note: You must make sure when you are passing lexicon to `Agent`, you have at least `default` context in groups.**

We provide two methods to integrate `Agent` with your application.

### You already have Lexicon in your context, if you are trying to integrate `Agent` in browser end, you should follow this method

`Agent` module exports the core method for toggleOption.

* ToggleOption
   
```
const Agent = require('@tesla/agent');

let optionListAfterToggle = Agent.toggleOption({
    options: [],                      
    option: '$APPA',                  
    lexicon: lexiconInContext,        
    action: Agent.TYPES.UNSET_RULE_ACTION   
});
```

`toggleOption` method accept an object as parameter and return an array.

| Key     | Type   | Description                                                                                        |
|   -     | -      | -                                                                                                  |
| options | Array  | Current option list before option toggling                                                         |
| option  | String | Option code you want to set/unset                                                                  |
| lexicon | Object | lexicon from OCW                                                                                   |
| action  | String | **Agent.TYPES.UNSET_RULE_ACTION** for unset option, **Agent.TYPES.SET_RULE_ACTION** for set option |

* ToggleOptionByGroup
   
```
const Agent = require('@tesla/agent');

let optionListAfterToggle = Agent.toggleOptionByGroup({
    options: ['$APPA'],                      
    option: '$APPA',                  
    lexicon: lexiconInContext 
});
```

`toggleOptionByGroup` method accept an object as parameter and return an array.

| Key    | Type  | Description                                |
|   -    | -     | -                                          |
| options| Array | Current option list before option toggling |
| option | String| Option code you want to set/unset          |
| lexicon| Object| lexicon from OCW                           |

Note: this method will assume the default action is set, only if the option already exists in options and the group of the option is neither exclusive nor required, we will switch the action to unset automatically.

* ToggleOptions
   
```
const Agent = require('@tesla/agent');

let optionListAfterToggle = Agent.toggleOptions({
    options: [],                
    lexicon: lexiconInContext,        
    actions: [{
    		action: Agent,TYPES.UNSET_RULE_ACTION,
    		target: '$AAAA'
    },{
    		action: Agent,TYPES.SET_RULE_ACTION,
    		target: '$BBBB'
    }]]
});
```


`toggleOptions` method accept an object as parameter and return an array, it will follow the sequence of `actions` to toggle option

| Key     | Type            | Description                                                  |
|   -     | -               | -                                                            |
| options | Array           | Current option list before option toggling                   |
| lexicon | Object          | lexicon from OCW                                             |
| actions | Array of Object | Array object should contains target (option code) and action |
	   
	   
* Transform
	   
`mapOptions` method accept two parameters and return an array.  
	   
```
const Agent = require('@tesla/agent');

let sourceOptionList = ['$APPA', 'BT35'];
let mappingLexicons = [{},{},{}]; // The mapping lexicons from OCW
let type = Agent.TYPES.TRANSFORM_MARKETING_TO_MANUFACTURING;
let mappedOptionList = Agent.mapOptions(sourceOptionList, mappingLexicons, type);
```   
| Params           | Type   | Description                                                                                                                                                                                      |
|   -              | -      | -                                                                                                                                                                                                |
| sourceOptionList | Array  | Current option list before option toggling                                                                                                                                                       |
| mappingLexicons  | Array  | Mapping lexicons from OCW, this array contains three lexicon, they are marketing/marketingToManufacturing/manufacturing lexicon, please follow the sequence to construct the array               |
| type             | String | Mapping type, default is Agent.TYPES.TRANSFORM_MARKETING_TO_MANUFACTURING, you can pass Agent.TYPES.TRANSFORM_MANUFACTURING_TO_MARKETING if you want to do mfg => mkt option list transformation |
  	   
  	   
* Validation 
	   
`validateRules` method accept two parameters and return an object as the validation result.

```
const Agent = require('@tesla/agent');

let optionListToBeValidated = ['$APPA', 'BT35'];
let lexicon = {}; // The lexicon from OCW
let validationResult = Agent.validateRules(optionListToBeValidated, lexicon);
```

| Params                 | Type  | Description                            |
| -                      | -     | -                                      |
| optionListToBeValidated| Array | Current option list before validation  |
| lexicon                | Object| Mapping lexicon from OCW               |

Response

| Key             | Type    | Description                |
| -               | -       | -                          |
| success         | Boolean | Validation flag            |
| message         | String  | Validation Result Message  |
| code            | String  | Validation result code     |

`validateRulesAndPrice` method accept three parameters and return an object as the validation result.

```
const Agent = require('@tesla/agent');

let configuration = {
    options: [
        {
            code: '$APPA',
            price: 0
        },
        {
            code: 'BT35',
            price: 0
        }
    ]
};
let lexicon = {}; // The lexicon from OCW
let validationResult = Agent.validateRulesAndPrice(configuration, lexicon);
```

| Params        | Type    | Description                             |
| -             | -       | -                                       |
| configuration | object  | Current option list before validation   |
| type          | String  | ValidationType, check Agent.TYPES       |
| lexicon       | Object  | Mapping lexicon from OCW                |

| Key       | Type    | Description                             |
| -         | -       | -                                       |
| success   | Boolean | Validation flag                         |
| message   | String  | Validation result message               |
| code      | String  | Validation result code                  |

`validatePrice` method accept three parameters and return an object as the validation result.

```
const Agent = require('@tesla/agent');

let options = [
    {
        code: '$APPA',
        price: 0,
        isCustomPricing: false
    },
    {
        code: 'BT35',
        price: 1000,
        isCustomPricing: true
    }
];
let lexicon = {}; // The lexicon from OCW
let validationResult = Agent.validatePrice(options, lexicon);
```

| Params   | Type  | Description                                  |
| -        | -     | -                                            |
| options  | Array | Current options with price before validation |
| type     | String| Validation type                              |
| lexicon  | Object| Mapping lexicon from OCW                     |

Response

| Key     | Type    | Description                |
| -       | -       | -                          |
| success | Boolean | Validation flag            |
| message | String  | Validation result message  |
| code    | String  | Validation result code     |

**Warning:** If you are validating the price marketing configuration, you must understand
* Only If the validation type is the new type `VALIDATION_TYPE_MARKETING_WITH_CUSTOM_PRICING` or `VALIDATION_TYPE_MARKETING_BY_VMID_WITH_CUSTOM_PRICING`, we will check the flag `isCustomPricing` to determine the pricing validation result.
* For all other validation type, we will only compare the pricing data between client request and lexicon.
* If you want to validate price with subtotal, you can try `validatePriceWithSubtotal` or `validateRulesAndPriceWithSubtotal`.


* getSubTotal

`getSubTotal` method accept two parameters and return an float as the validation result.  
   
```
const Agent = require('@tesla/agent');

let optionList = ['$APPA', 'BT35'];
let lexicon = {}; // The lexicon from OCW
let subTotal = Agent.getSubTotal(optionList, lexicon);
```
   
| Params       | Type  | Description                              |
| -            | -     | -                                        |
| optionList   | Array | Current option list to get the subTotal  |
| lexicon      | Object| Lexicon from OCW                         |

* getAllPossibleConfigurations

`getAllPossibleConfigurations` will let you know all possible configurations by lexicon.

```
const Agent = require('@tesla/agent');

let lexicon = {
    groups: [
        {
            options: [
                "AAAA",
                "BBBB"
            ],
            required: true

        },
        {
            options: [
                "CCCC",
                "BBBB"
            ],
            required: true

        }
    ]
}; // The lexicon from OCW
let subTotal = Agent.getSubTotal(optionList, lexicon);
```


* Migration
       
`migrate` method accept three parameters and return an object.  
       
```
const Agent = require('@tesla/agent');

let mappedOptionList = Agent.migrate(sourceConfiguration, sourceLexicon, targetLexicon);
```   
| Params              | Type   | Description                            |
| -                   | -      | -                                      |
| sourceConfiguration | Object | Current configuration before migrating |
| sourceLexicon       | Object | Current lexicon                        |
| targetLexicon       | Object | Target lexicon after migrating         |

Response

| Key     | Type    | Description               |
| -       | -       | -                         |
| success | Boolean | Migration flag            |
| message | String  | Migration result message  |
| code    | String  | Migration result code     |
| data    | Array   | Migration result          |

We will compare the `sourceLexicon` and `targetLexicon`, then apply the logic to `upgrade`/`downgrade` based on the comparing result.


* Upgrade
       
`upgrade` method accept two parameters and return an object.  
       
```
const Agent = require('@tesla/agent');

let potentialUpgradedOptionList = Agent.upgrade(optionList, lexicon);
```   
| Params      | Type   | Description                            |
| -           | -      | -                                      |
| optionList  | Object | Current configuration before migrating |
| lexicon     | Object | Current lexicon                        |

Response

| Key     | Type    | Description             |
| -       | -       | -                       |
| success | Boolean | Upgrade  flag           |
| message | String  | Upgrade result message  |
| code    | String  | Upgrade result code     |
| data    | Array   | Upgrade result          |

We will compare the `sourceLexicon` and `targetLexicon`, then apply the logic to `upgrade`/`downgrade` based on the comparing result.


* Matching

`matching` method accept two parameters and return an float as the validation result.  
   
```
const Agent = require('@tesla/agent');

let customerOptions = ['APH3', 'APF2', 'AAAA'];
let inventoryOptions = ['APH3', 'APF1', 'BBBB'];
let lexicon = {}; // The lexicon from OCW with matching rules defined
/**
{
    "context": "matching",
    "code": "FIRMWARE_MATCHING",
    "excludes": "true",
    "required": "true",
    "options": [
        "APF0",
        "APF1",
        "APF2"
    ]
}
*/
let matchedInventoryOptions = Agent.matching(customerOptions, inventoryOptions, lexicon);
// Here we should get ['APH3', 'APF2', 'BBBB']
```
| Params           | Type  | Description                                             |
| -                | -     | -                                                       |
| customerOptions  | Array | Manufacturing option list of customer's order           |
| customerOptions  | Array | Manufacturing option list of current inventory vehicle  |
| lexicon          | Object| Lexicon from OCW with matching rules defined            |

### You don't have any context about Lexicon, if you are trying to integrate `Agent` in backend, you should consider this method

Before you start coding, you must inject environment sensitives informations to `Agent` by NodeJS runtime `process.env`.
      
```
process.env.OCW_API_TOKEN
process.env.OCW_API_HOST
process.env.OCW_LBN_HOST

```
   
You can check [AgentService](https://stash.teslamotors.com/projects/OCW/repos/agent-service/browse/docker-compose/local.yml) as the example.


In this case we provide three different types for you to integration if you don't have any context about Lexicon.

* Callback
	
Common JavaScript callback method

```
const Agent = require('@tesla/agent');

Agent.validate(params, function(result) {
    // Here is the validation result
});

Agent.transform(params, function(result) {
    // Here is the transform result
});
```
	  
* Promise
	
Promise/Then way to let you chain your workflow

```
const Agent = require('@tesla/agent');

Agent.validatePromise(params)
    .then(function(result) {
    // Here is the validation result
    });

Agent.transformPromise(params)
    .then(function(result) {
	  // Here is the transform result
    });
```
	  
* Observable
	
  If you are using RxJS, you can integrate our observable in your data stream

```
const Agent = require('@tesla/agent');

Agent.validateObservable$(params)
    .subscribe(function(result) {
        // Here is the validation result
    });

Agent.transformObservable$(params)
    .subscribe(function(result) {
        // Here is the transform result
    });
```
	  
For the params structure, please see [Agent](https://confluence.teslamotors.com/display/OC/Agent) documentation for the details. 
	
**We accept bulk validation/transform as well. You can pass an array with multiple configuration items**

* If you are passing configurations as an Array, we will process all of them and return you an array with the validation/transform results.
* If you are passing configuration as an Object, we will process it and return you an object with the validation/transform results.

### Examples

Here we have to example project in the `examples` folder.

We have some other projects which have already integrated with `Agent`

* [`Configuration Tool (mini-desgin-studio)`](https://stash.teslamotors.com/projects/OCW/repos/ocw-configuration-tool/browse) is one pure JavaScript application with integrates with `Agent`, you can check the details there.


* [`AgentService`](https://stash.teslamotors.com/projects/OCW/repos/agent-service/browse) is another NodeJS application which integrates with `Agent` as well, you can check the details there.
